{"version":3,"file":"\\packages\\ctl-helper.js","sources":["ctl-helper/ctl-helper.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAAA,uC;AACA,0C;;AAEA,S;;AAEA,e;AACA,oB;;AAEA,e;AACA,e;;AAEA,yB;AACA,4B;AACA,6B;AACA,2B;AACA,oB;;AAEA,oB;AACA,kC;AACA,uB;AACA,K;;AAEA,yB;AACA,sB;AACA,sC;;AAEA,wC;AACA,qB;AACA,a;AACA,I;;AAEA,uE;AACA,sC;AACA,gE;AACA,2B;AACA,8D;AACA,Y;AACA,+C;AACA,K;AACA,gB;AACA,I;;AAEA,2D;AACA,mC;AACA,kE;AACA,oC;AACA,8B;AACA,oB;;AAEA,qB;AACA,8B;AACA,oB;AACA,8B;AACA,kB;AACA,uF;AACA,O;AACA,iE;AACA,K;;AAEA,8E;AACA,mD;AACA,mD;AACA,oE;AACA,+E;AACA,wE;AACA,O;;AAEA,qB;AACA,e;AACA,wB;AACA,sE;AACA,M;AACA,c;AACA,6B;AACA,gF;AACA,4B;AACA,e;AACA,c;AACA,iB;AACA,0B;AACA,8B;AACA,uE;AACA,8E;AACA,4E;AACA,sB;AACA,S;AACA,Q;AACA,gB;AACA,Q;AACA,oC;AACA,iB;AACA,I;;AAEA,gC;AACA,uD;AACA,gB;AACA,4E;AACA,sB;AACA,K;;AAEA,e;AACA,I;;AAEA,+B;AACA,4C;AACA,4D;AACA,qF;AACA,kB;AACA,mB;AACA,sB;AACA,qF;AACA,I;;AAEA,kC;AACA,qC;AACA,kB;AACA,yE;AACA,sB;AACA,K;;AAEA,0E;AACA,sD;AACA,6D;AACA,qD;AACA,yD;AACA,wB;AACA,O;AACA,e;AACA,sB;AACA,K;;AAEA,2B;AACA,qB;AACA,8B;AACA,K;AACA,0B;AACA,4C;AACA,6B;AACA,K;AACA,I;;AAEA,mD;AACA,c;AACA,0C;AACA,4B;AACA,yE;AACA,sD;AACA,a;AACA,kD;AACA,0B;AACA,a;AACA,wB;AACA,+B;AACA,iB;AACA,uE;AACA,oB;AACA,yB;AACA,sD;AACA,wB;AACA,sC;AACA,yC;AACA,sB;AACA,wB;AACA,e;AACA,a;AACA,W;AACA,6B;AACA,iD;AACA,6C;AACA,qB;AACA,iD;AACA,6C;AACA,S;AACA,O;AACA,O;;AAEA,sD;AACA,6C;AACA,sC;AACA,sD;AACA,gE;AACA,sE;AACA,U;AACA,gB;AACA,gC;AACA,sC;AACA,I;;AAEA,sC;AACA,sE;AACA,K;;AAEA,4D;AACA,oD;AACA,+D;AACA,K;;AAEA,6B;AACA,oD;AACA,kC;AACA,oC;AACA,kC;AACA,uB;AACA,yC;AACA,+C;AACA,I;;AAEA,iC;AACA,yC;AACA,kE;AACA,sB;AACA,K;AACA,kC;AACA,K;;AAEA,+B;AACA,yC;AACA,kE;AACA,sB;AACA,K;AACA,kC;AACA,K;;AAEA,qB;AACA,yB;AACA,kD;AACA,c;AACA,qF;AACA,oF;AACA,sD;AACA,c;AACA,uB;AACA,yC;AACA,qC;AACA,yE;AACA,6D;AACA,O;AACA,O;AACA,+B;AACA,yB;AACA,8D;AACA,oB;AACA,I;;AAEA,gD;AACA,6C;AACA,8B;;AAEA,0C;AACA,iC;;AAEA,oC;AACA,Y;AACA,uC;AACA,2C;AACA,8D;;AAEA,oB;AACA,I;;AAEA,gD;AACA,uD;AACA,S;AACA,yC;AACA,iB;AACA,qC;AACA,K;AACA,e;AACA,I;;AAEA,uC;AACA,qD;AACA,oD;AACA,G;AACA,G","sourcesContent":["var optimist = Npm.require('optimist');\r\nvar Future = Npm.require('fibers/future');\r\n\r\nCtl = {};\r\n\r\nvar connection;\r\nvar checkConnection;\r\n\r\n_.extend(Ctl, {\r\n  Commands: [],\r\n\r\n  main: function (argv) {\r\n    var opt = optimist(argv)\r\n          .alias('h', 'help')\r\n          .boolean('help');\r\n    argv = opt.argv;\r\n\r\n    if (argv.help) {\r\n      argv._.splice(0, 0, \"help\");\r\n      delete argv.help;\r\n    }\r\n\r\n    var cmdName = 'help';\r\n    if (argv._.length)\r\n      cmdName = argv._.splice(0,1)[0];\r\n\r\n    Ctl.findCommand(cmdName).func(argv);\r\n    Ctl.disconnect();\r\n    return 0;\r\n  },\r\n\r\n  startServerlikeProgramIfNotPresent: function (program, tags, admin) {\r\n    var numServers = Ctl.getJobsByApp(\r\n      Ctl.myAppName(), {program: program, done: false}).count();\r\n    if (numServers === 0) {\r\n      return Ctl.startServerlikeProgram(program, tags, admin);\r\n    } else {\r\n      console.log(program, \"already running.\");\r\n    }\r\n    return null;\r\n  },\r\n\r\n  startServerlikeProgram: function (program, tags, admin) {\r\n    var appConfig = Ctl.prettyCall(\r\n      Ctl.findGalaxy(), 'getAppConfiguration', [Ctl.myAppName()]);\r\n    if (typeof admin == 'undefined')\r\n      admin = appConfig.admin;\r\n    admin = !!admin;\r\n\r\n    var jobId = null;\r\n    var rootUrl = Ctl.rootUrl;\r\n    if (! rootUrl) {\r\n      var bindPathPrefix = \"\";\r\n      if (admin) {\r\n        bindPathPrefix = \"/\" + encodeURIComponent(Ctl.myAppName()).replace(/\\./g, '_');\r\n      }\r\n      rootUrl = \"https://\" + appConfig.sitename + bindPathPrefix;\r\n    }\r\n\r\n    // Allow appConfig settings to be objects or strings. We need to stringify\r\n    // them to pass them to the app in the env var.\r\n    // Backwards compat with old app config format.\r\n    _.each([\"settings\", \"METEOR_SETTINGS\"], function (settingsKey) {\r\n      if (appConfig[settingsKey] && typeof appConfig[settingsKey] === \"object\")\r\n        appConfig[settingsKey] = JSON.stringify(appConfig[settingsKey]);\r\n    });\r\n\r\n    // XXX args? env?\r\n    var env = {\r\n      ROOT_URL: rootUrl,\r\n      METEOR_SETTINGS: appConfig.settings || appConfig.METEOR_SETTINGS\r\n    };\r\n    if (admin)\r\n      env.ADMIN_APP = 'true';\r\n    jobId = Ctl.prettyCall(Ctl.findGalaxy(), 'run', [Ctl.myAppName(), program, {\r\n      exitPolicy: 'restart',\r\n      env: env,\r\n      ports: {\r\n        \"main\": {\r\n          bindEnv: \"PORT\",\r\n          routeEnv: \"ROUTE\"//,\r\n          //bindIpEnv: \"BIND_IP\" // Later, we can teach Satellite to do\r\n          //something like recommend the process bind to a particular IP here.\r\n          //For now, we don't have a way of setting this, so Satellite binds\r\n          //to 0.0.0.0\r\n        }\r\n      },\r\n      tags: tags\r\n    }]);\r\n    console.log(\"Started\", program);\r\n    return jobId;\r\n  },\r\n\r\n  findCommand: function (name) {\r\n    var cmd = _.where(Ctl.Commands, { name: name })[0];\r\n    if (! cmd) {\r\n      console.log(\"'\" + name + \"' is not a ctl command. See 'ctl --help'.\");\r\n      process.exit(1);\r\n    }\r\n\r\n    return cmd;\r\n  },\r\n\r\n  hasProgram: function (name) {\r\n    Ctl.subscribeToAppJobs(Ctl.myAppName());\r\n    var myJob = Ctl.jobsCollection().findOne(Ctl.myJobId());\r\n    var manifest = Ctl.prettyCall(Ctl.findGalaxy(), 'getStarManifest', [myJob.star]);\r\n    if (!manifest)\r\n      return false;\r\n    var found = false;\r\n    return _.find(manifest.programs, function (prog) { return prog.name === name; });\r\n  },\r\n\r\n  findGalaxy: _.once(function () {\r\n    if (!('GALAXY' in process.env)) {\r\n      console.log(\r\n        \"GALAXY environment variable must be set. See 'galaxy --help'.\");\r\n      process.exit(1);\r\n    }\r\n\r\n    connection = Follower.connect(process.env['ULTRAWORLD_DDP_ENDPOINT']);\r\n    checkConnection = Meteor.setInterval(function () {\r\n      if (Ctl.findGalaxy().status().status !== \"connected\" &&\r\n          Ctl.findGalaxy().status().retryCount > 2) {\r\n        console.log(\"Cannot connect to galaxy; exiting\");\r\n        process.exit(3);\r\n      }\r\n    }, 2*1000);\r\n    return connection;\r\n  }),\r\n\r\n  disconnect: function () {\r\n    if (connection) {\r\n      connection.disconnect();\r\n    }\r\n    if (checkConnection) {\r\n      Meteor.clearInterval(checkConnection);\r\n      checkConnection = null;\r\n    }\r\n  },\r\n\r\n  updateProxyActiveTags: function (tags, options) {\r\n    var proxy;\r\n    var proxyTagSwitchFuture = new Future;\r\n    options = options || {};\r\n    AppConfig.configureService('proxy', 'pre0', function (proxyService) {\r\n      if (proxyService && ! _.isEmpty(proxyService)) {\r\n        try {\r\n          proxy = Follower.connect(proxyService, {\r\n            group: \"proxy\"\r\n          });\r\n          var tries = 0;\r\n          while (tries < 100) {\r\n            try {\r\n              proxy.call('updateTags', Ctl.myAppName(), tags, options);\r\n              break;\r\n            } catch (e) {\r\n              if (e.error === 'not-enough-bindings') {\r\n                tries++;\r\n                // try again in a sec.\r\n                Meteor._sleepForMs(1000);\r\n              } else {\r\n                throw e;\r\n              }\r\n            }\r\n          }\r\n          proxy.disconnect();\r\n          if (!proxyTagSwitchFuture.isResolved())\r\n            proxyTagSwitchFuture['return']();\r\n        } catch (e) {\r\n          if (!proxyTagSwitchFuture.isResolved())\r\n            proxyTagSwitchFuture['throw'](e);\r\n        }\r\n      }\r\n    });\r\n\r\n    var proxyTimeout = Meteor.setTimeout(function () {\r\n      if (!proxyTagSwitchFuture.isResolved())\r\n        proxyTagSwitchFuture['throw'](\r\n          new Error(\"Timed out looking for a proxy \" +\r\n                    \"or trying to change tags on it. Status: \" +\r\n                    (proxy ? proxy.status().status : \"no connection\"))\r\n        );\r\n    }, 50*1000);\r\n    proxyTagSwitchFuture.wait();\r\n    Meteor.clearTimeout(proxyTimeout);\r\n  },\r\n\r\n  jobsCollection: _.once(function () {\r\n    return new Meteor.Collection(\"jobs\", {manager: Ctl.findGalaxy()});\r\n  }),\r\n\r\n  // use _.memoize so that this is called only once per app.\r\n  subscribeToAppJobs: _.memoize(function (appName) {\r\n    Ctl.findGalaxy()._subscribeAndWait(\"jobsByApp\", [appName]);\r\n  }),\r\n\r\n  // XXX this never unsubs...\r\n  getJobsByApp: function (appName, restOfSelector) {\r\n    var galaxy = Ctl.findGalaxy();\r\n    Ctl.subscribeToAppJobs(appName);\r\n    var selector = {app: appName};\r\n    if (restOfSelector)\r\n      _.extend(selector, restOfSelector);\r\n    return Ctl.jobsCollection().find(selector);\r\n  },\r\n\r\n  myAppName: _.once(function () {\r\n    if (!('GALAXY_APP' in process.env)) {\r\n      console.log(\"GALAXY_APP environment variable must be set.\");\r\n      process.exit(1);\r\n    }\r\n    return process.env.GALAXY_APP;\r\n  }),\r\n\r\n  myJobId: _.once(function () {\r\n    if (!('GALAXY_JOB' in process.env)) {\r\n      console.log(\"GALAXY_JOB environment variable must be set.\");\r\n      process.exit(1);\r\n    }\r\n    return process.env.GALAXY_JOB;\r\n  }),\r\n\r\n  usage: function() {\r\n    process.stdout.write(\r\n      \"Usage: ctl [--help] <command> [<args>]\\n\" +\r\n        \"\\n\" +\r\n        \"For now, the GALAXY environment variable must be set to the location of\\n\" +\r\n        \"your Galaxy management server (Ultraworld.) This string is in the same\\n\" +\r\n        \"format as the argument to DDP.connect().\\n\" +\r\n        \"\\n\" +\r\n        \"Commands:\\n\");\r\n    _.each(Ctl.Commands, function (cmd) {\r\n      if (cmd.help && ! cmd.hidden) {\r\n        var name = cmd.name + \"                \".substr(cmd.name.length);\r\n        process.stdout.write(\"   \" + name + cmd.help + \"\\n\");\r\n      }\r\n    });\r\n    process.stdout.write(\"\\n\");\r\n    process.stdout.write(\r\n      \"See 'ctl help <command>' for details on a command.\\n\");\r\n    process.exit(1);\r\n  },\r\n\r\n  // XXX copied to meteor/tools/deploy-galaxy.js\r\n  exitWithError: function (error, messages) {\r\n    messages = messages || {};\r\n\r\n    if (! (error instanceof Meteor.Error))\r\n      throw error; // get a stack\r\n\r\n    var msg = messages[error.error];\r\n    if (msg)\r\n      process.stderr.write(msg + \"\\n\");\r\n    else if (error instanceof Meteor.Error)\r\n      process.stderr.write(\"Denied: \" + error.message + \"\\n\");\r\n\r\n    process.exit(1);\r\n  },\r\n\r\n  // XXX copied to meteor/tools/deploy-galaxy.js\r\n  prettyCall: function (galaxy, name, args, messages) {\r\n    try {\r\n      var ret = galaxy.apply(name, args);\r\n    } catch (e) {\r\n      Ctl.exitWithError(e, messages);\r\n    }\r\n    return ret;\r\n  },\r\n\r\n  kill: function (programName, jobId) {\r\n  console.log(\"Killing %s (%s)\", programName, jobId);\r\n  Ctl.prettyCall(Ctl.findGalaxy(), 'kill', [jobId]);\r\n  }\r\n});\r\n"]}